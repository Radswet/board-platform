<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Tablero</title>
  <!-- Supabase JS (CDN, no build step needed) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  CONFIGURACIÃ“N SUPABASE â€“ lee esto primero               â•‘
  â•‘                                                          â•‘
  â•‘  1. Ve a https://supabase.com y crea una cuenta gratis   â•‘
  â•‘  2. Crea un nuevo proyecto                               â•‘
  â•‘  3. Ve a Project Settings > API y copia:                 â•‘
  â•‘     - Project URL  â†’ SUPABASE_URL                        â•‘
  â•‘     - anon / public key â†’ SUPABASE_KEY                   â•‘
  â•‘  4. Ve a SQL Editor y ejecuta el SQL de setup.sql        â•‘
  â•‘  5. Pega los valores abajo en la secciÃ³n CONFIG          â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->

  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Loading inicial -->
<div id="loading-overlay" class="loading-overlay">
  <div class="spinner"></div>
  <span>Cargando...</span>
</div>

<!-- â”€â”€ AUTH VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="auth-view" class="hidden">
  <div class="auth-card">
    <div class="auth-logo">âœ¦</div>
    <h1 class="auth-title">Mi Tablero</h1>

    <div class="tab-switcher">
      <button class="tab-btn active" id="tab-login-btn">Iniciar sesiÃ³n</button>
      <button class="tab-btn" id="tab-signup-btn">Registrarse</button>
    </div>

    <!-- Login -->
    <div id="login-panel">
      <div class="field">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="tu@email.com" autocomplete="email">
      </div>
      <div class="field">
        <label>ContraseÃ±a</label>
        <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>
      <button class="primary full" id="btn-login">Iniciar sesiÃ³n</button>
    </div>

    <!-- Signup -->
    <div id="signup-panel" class="hidden">
      <div class="field">
        <label>Email</label>
        <input type="email" id="signup-email" placeholder="tu@email.com" autocomplete="email">
      </div>
      <div class="field">
        <label>ContraseÃ±a</label>
        <input type="password" id="signup-pass" placeholder="MÃ­nimo 6 caracteres" autocomplete="new-password">
      </div>
      <button class="primary full" id="btn-signup">Crear cuenta</button>
    </div>

    <p id="auth-msg" class="auth-msg hidden"></p>
  </div>
</div>

<!-- â”€â”€ DASHBOARD VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="dash-view" class="hidden">

  <div id="config-banner" class="config-banner hidden">
    âš ï¸ <strong>ConfiguraciÃ³n pendiente:</strong> Abre <code>index.html</code> y reemplaza
    <code>TU_SUPABASE_URL</code> y <code>TU_SUPABASE_ANON_KEY</code> con tus credenciales.
    Luego ejecuta el SQL en tu proyecto Supabase.
  </div>

  <header>
    <input type="text" id="site-title" value="âœ¦ Mi Tablero" maxlength="40" title="Haz clic para editar el tÃ­tulo">
    <div class="controls">
      <span class="user-limit-badge hidden" id="user-limit-badge"></span>
      <span class="user-badge" id="user-badge">...</span>
      <button id="btn-logout">Salir</button>
      <button class="primary" id="btn-add">+ Agregar</button>
    </div>
  </header>

  <div class="search-wrap">
    <input type="search" id="search" placeholder="Buscar acceso...">
  </div>

  <div class="canvas-wrap">
    <div id="canvas"></div>
  </div>
</div>

<!-- â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay hidden" id="overlay">
  <div class="modal" role="dialog" aria-modal="true">
    <h2 id="modal-title">Nuevo acceso</h2>

    <div class="field">
      <label>Emoji / Icono</label>
      <input type="text" id="f-icon" placeholder="ğŸ”— o pega una URL de imagen">
    </div>
    <div class="field">
      <label>Nombre *</label>
      <input type="text" id="f-name" placeholder="GitHub" autocomplete="off">
    </div>
    <div class="field">
      <label>URL <span style="opacity:0.5;font-weight:400">(opcional â€” sin URL serÃ¡ una nota)</span></label>
      <input type="url" id="f-url" placeholder="https://...">
      <div class="favicon-row hidden" id="favicon-row">
        <div class="favicon-preview" id="favicon-preview"></div>
        <span style="font-size:0.78rem;color:var(--muted);">Favicon detectado</span>
        <button type="button" class="favicon-use-btn" id="favicon-use-btn">Usar como Ã­cono</button>
      </div>
    </div>
    <div class="field">
      <label id="desc-label">DescripciÃ³n (opcional)</label>
      <textarea id="f-desc" placeholder="Breve descripciÃ³n..." rows="2" style="width:100%;background:#111;border:1px solid var(--border);border-radius:10px;padding:10px 13px;color:var(--text);font-size:0.92rem;font-family:inherit;outline:none;resize:vertical;transition:border-color 0.15s;"></textarea>
    </div>
    <div class="field">
      <label>Color</label>
      <div class="colors" id="color-palette"></div>
    </div>

    <div class="modal-footer">
      <button class="danger hidden" id="btn-delete">Eliminar</button>
      <button id="btn-cancel">Cancelar</button>
      <button class="primary" id="btn-save">Guardar</button>
    </div>
  </div>
</div>

<!-- â”€â”€ NOTE POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay hidden" id="note-overlay">
  <div class="modal note-popup" role="dialog">
    <div class="note-popup-pin">ğŸ“Œ</div>
    <h2 id="note-popup-title"></h2>
    <p id="note-popup-body"></p>
    <div class="modal-footer">
      <button id="note-popup-edit">âœï¸ Editar</button>
      <button class="primary" id="note-popup-close">Cerrar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- â”€â”€ SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  CONFIG â€” Pega aquÃ­ tus credenciales de Supabase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = window.APP_CONFIG?.supabaseUrl || '';
const SUPABASE_KEY = window.APP_CONFIG?.supabaseKey || '';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const COLORS = [
  '#f87171','#fb923c','#fbbf24','#facc15',
  '#a3e635','#4ade80','#34d399','#2dd4bf',
  '#22d3ee','#60a5fa','#818cf8','#a78bfa',
  '#c084fc','#f472b6','#fb7185','#e2e8f0',
];

const TITLE_KEY = 'tablero_title';

let sb;
let links = [];
let currentUser = null;
let editingId = null;
let selectedColor = COLORS[0];
let isDragging = false;
let searchQuery = '';
let realtimeChannel = null;
let isSaving = false;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const isConfigured = SUPABASE_URL !== 'TU_SUPABASE_URL' && SUPABASE_KEY !== 'TU_SUPABASE_ANON_KEY';

  if (!isConfigured) {
    // Show dashboard in demo mode with warning
    hide('loading-overlay');
    show('dash-view');
    show('config-banner');
    document.getElementById('user-badge').textContent = 'modo demo';
    links = getDemoLinks();
    render();
    return;
  }

  try {
    const { createClient } = supabase;
    sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    const { data: { session } } = await sb.auth.getSession();
    hide('loading-overlay');

    if (session) {
      onAuth(session.user);
    } else {
      show('auth-view');
    }

    sb.auth.onAuthStateChange((_event, session) => {
      if (session) onAuth(session.user);
      else onSignOut();
    });
  } catch (err) {
    hide('loading-overlay');
    show('auth-view');
    showAuthMsg('Error de configuraciÃ³n: ' + err.message, 'error');
  }
}

function onAuth(user) {
  currentUser = user;
  hide('auth-view');
  show('dash-view');
  document.getElementById('user-badge').textContent = user.email;

  const savedTitle = localStorage.getItem(TITLE_KEY);
  if (savedTitle) {
    document.getElementById('site-title').value = savedTitle;
    document.title = savedTitle.replace(/[^\w\s]/g,'').trim() || 'Mi Tablero';
  }

  loadLinks();
  subscribeRealtime();
  checkUserLimit();
}

function onSignOut() {
  currentUser = null;
  links = [];
  if (realtimeChannel) sb.removeChannel(realtimeChannel);
  hide('dash-view');
  show('auth-view');
  render();
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function login() {
  const email = val('login-email');
  const pass  = val('login-pass');
  if (!email || !pass) return;

  setDisabled('btn-login', true, 'Entrando...');
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  setDisabled('btn-login', false, 'Iniciar sesiÃ³n');

  if (error) showAuthMsg(translateError(error.message), 'error');
}

async function signup() {
  const email = val('signup-email');
  const pass  = val('signup-pass');
  if (!email || !pass) return;
  if (pass.length < 6) { showAuthMsg('La contraseÃ±a debe tener al menos 6 caracteres', 'error'); return; }

  setDisabled('btn-signup', true, 'Creando cuenta...');
  const { error } = await sb.auth.signUp({ email, password: pass });
  setDisabled('btn-signup', false, 'Crear cuenta');

  if (error) showAuthMsg(translateError(error.message), 'error');
  else showAuthMsg('Â¡Cuenta creada! Revisa tu email para confirmarla.', 'success');
}

async function logout() {
  await sb.auth.signOut();
}

function translateError(msg) {
  if (msg.includes('Invalid login')) return 'Email o contraseÃ±a incorrectos';
  if (msg.includes('already registered')) return 'Este email ya estÃ¡ registrado';
  if (msg.includes('Email not confirmed')) return 'Confirma tu email antes de entrar';
  return msg;
}

// â”€â”€ Auth UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  const isLogin = tab === 'login';
  document.getElementById('login-panel').classList.toggle('hidden', !isLogin);
  document.getElementById('signup-panel').classList.toggle('hidden', isLogin);
  document.getElementById('tab-login-btn').classList.toggle('active', isLogin);
  document.getElementById('tab-signup-btn').classList.toggle('active', !isLogin);
  document.getElementById('auth-msg').classList.add('hidden');
}

function showAuthMsg(msg, type) {
  const el = document.getElementById('auth-msg');
  el.textContent = msg;
  el.className = 'auth-msg ' + type;
  el.classList.remove('hidden');
}

// â”€â”€ User limit check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkUserLimit() {
  if (!sb) return;
  const { count } = await sb.from('profiles').select('*', { count: 'exact', head: true });
  if (count === null) return;

  const badge = document.getElementById('user-limit-badge');
  const MAX = 5;
  badge.textContent = `ğŸ‘¤ ${count}/${MAX} usuarios`;
  badge.classList.remove('hidden', 'warn', 'full');

  if (count >= MAX) {
    badge.classList.add('full');
    showToast(`âš ï¸ LÃ­mite alcanzado: ${MAX}/${MAX} usuarios registrados`);
  } else if (count >= MAX - 1) {
    badge.classList.add('warn');
  }
}

// â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLinks() {
  if (!sb) return;
  const { data, error } = await sb
    .from('links')
    .select('*')
    .order('position', { ascending: true });

  if (error) { showToast('Error al cargar links'); return; }
  links = data || [];
  render();
}

async function upsertLink(payload) {
  if (!sb) return;
  isSaving = true;

  if (payload.id) {
    const { id, ...rest } = payload;
    const { error } = await sb.from('links').update(rest).eq('id', id);
    if (error) showToast('Error al actualizar: ' + error.message);
  } else {
    const maxPos = links.length ? Math.max(...links.map(l => l.position ?? 0)) + 1 : 0;
    const { error } = await sb.from('links').insert({
      ...payload,
      position: maxPos,
      created_by: currentUser.id,
    });
    if (error) showToast('Error al guardar: ' + error.message);
  }

  isSaving = false;
  // Realtime will trigger reload, but call anyway for immediate feedback
  await loadLinks();
}

async function removeLink(id) {
  if (!sb) return;
  const { error } = await sb.from('links').delete().eq('id', id);
  if (error) showToast('Error al eliminar');
  else await loadLinks();
}

async function saveOrder() {
  if (!sb || links.length === 0) return;
  await Promise.all(
    links.map((l, i) => sb.from('links').update({ position: i }).eq('id', l.id))
  );
}

// â”€â”€ Realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subscribeRealtime() {
  if (!sb) return;
  if (realtimeChannel) sb.removeChannel(realtimeChannel);

  realtimeChannel = sb.channel('links-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'links' }, () => {
      if (!isSaving && !isDragging) loadLinks();
    })
    .subscribe();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TILE_W = 158, TILE_H = 130, TILE_GAP = 20;

function autoPos(index) {
  const cols = Math.max(1, Math.floor((window.innerWidth - 60) / (TILE_W + TILE_GAP)));
  return {
    x: (index % cols) * (TILE_W + TILE_GAP) + 20,
    y: Math.floor(index / cols) * (TILE_H + TILE_GAP) + 20,
  };
}

function render() {
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = '';

  const visible = searchQuery
    ? links.filter(l =>
        l.name.toLowerCase().includes(searchQuery) ||
        (l.description || '').toLowerCase().includes(searchQuery)
      )
    : links;

  if (visible.length === 0 && searchQuery) {
    const msg = document.createElement('p');
    msg.className = 'empty';
    msg.style.cssText = 'position:absolute;top:40px;left:50%;transform:translateX(-50%);';
    msg.textContent = `Sin resultados para "${searchQuery}"`;
    canvas.appendChild(msg);
    return;
  }

  visible.forEach((link, i) => canvas.appendChild(createTile(link, i)));
}

function createTile(link, index = 0) {
  const isNote = !link.url;
  const bg = link.color || COLORS[0];
  const pos = (link.pos_x != null && link.pos_y != null)
    ? { x: link.pos_x, y: link.pos_y }
    : autoPos(index);

  const tile = document.createElement('div');
  tile.className = 'tile' + (isNote ? ' tile-note' : '');
  tile.dataset.id = link.id;
  tile.style.background = bg;
  tile.style.color = isLight(bg) ? 'rgba(0,0,0,0.85)' : 'rgba(255,255,255,0.92)';
  tile.style.left = pos.x + 'px';
  tile.style.top  = pos.y + 'px';

  tile.innerHTML = isNote ? `
    <div class="tile-actions">
      <button class="tile-btn" title="Editar" tabindex="-1">âœï¸</button>
    </div>
    <div class="tile-pin">ğŸ“Œ</div>
    <div class="tile-name">${esc(link.name)}</div>
    ${link.description ? `<div class="tile-note-body">${esc(link.description)}</div>` : ''}
  ` : `
    <div class="tile-actions">
      <button class="tile-btn" title="Editar" tabindex="-1">âœï¸</button>
    </div>
    <div class="tile-icon">${renderIcon(link.icon)}</div>
    <div class="tile-name">${esc(link.name)}</div>
    ${link.description ? `<div class="tile-desc">${esc(link.description)}</div>` : ''}
  `;

  tile.querySelector('.tile-btn').addEventListener('click', e => {
    e.preventDefault();
    e.stopPropagation();
    openModal(link.id);
  });

  initTileDrag(tile, link, isNote);
  return tile;
}

function showNote(link) {
  document.getElementById('note-popup-title').textContent = link.name;
  document.getElementById('note-popup-body').textContent = link.description || '(sin contenido)';
  document.getElementById('note-popup-edit').dataset.id = link.id;
  document.getElementById('note-overlay').classList.remove('hidden');
}

function closeNote() {
  document.getElementById('note-overlay').classList.add('hidden');
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id, defaultGroup = '') {
  editingId = id;
  const delBtn = document.getElementById('btn-delete');

  if (id) {
    const link = links.find(l => l.id === id);
    document.getElementById('modal-title').textContent = 'Editar acceso';
    document.getElementById('f-icon').value = link.icon || '';
    document.getElementById('f-name').value = link.name;
    document.getElementById('f-url').value = link.url;
    document.getElementById('f-desc').value = link.description || '';
    selectedColor = link.color || COLORS[0];
    delBtn.classList.remove('hidden');
  } else {
    document.getElementById('modal-title').textContent = 'Nuevo acceso';
    document.getElementById('f-icon').value = '';
    document.getElementById('f-name').value = '';
    document.getElementById('f-url').value = '';
    document.getElementById('f-desc').value = '';
    selectedColor = COLORS[Math.floor(Math.random() * COLORS.length)];
    delBtn.classList.add('hidden');
  }

  // Reset favicon preview
  document.getElementById('favicon-row').classList.add('hidden');
  document.getElementById('favicon-preview').innerHTML = '';

  buildPalette();
  document.getElementById('overlay').classList.remove('hidden');
  setTimeout(() => document.getElementById('f-name').focus(), 60);
}

function closeModal() {
  document.getElementById('overlay').classList.add('hidden');
  editingId = null;
}

function buildPalette() {
  const palette = document.getElementById('color-palette');
  palette.innerHTML = '';
  COLORS.forEach(c => {
    const el = document.createElement('div');
    el.className = 'color-opt' + (c === selectedColor ? ' selected' : '');
    el.style.background = c;
    el.addEventListener('click', () => {
      selectedColor = c;
      palette.querySelectorAll('.color-opt').forEach(x => x.classList.remove('selected'));
      el.classList.add('selected');
    });
    palette.appendChild(el);
  });
}


async function saveLink() {
  const icon  = val('f-icon') || 'ğŸ”—';
  const name  = val('f-name');
  const url   = val('f-url');
  const desc  = val('f-desc');
  if (!name) { document.getElementById('f-name').focus(); showToast('El nombre es obligatorio'); return; }

  setDisabled('btn-save', true, 'Guardando...');

  const payload = { icon, name, url, description: desc, color: selectedColor };
  if (editingId) payload.id = editingId;

  await upsertLink(payload);

  setDisabled('btn-save', false, 'Guardar');
  showToast(editingId ? 'Acceso actualizado' : 'Acceso agregado');
  closeModal();
}

async function deleteLink() {
  if (!editingId) return;
  const link = links.find(l => l.id === editingId);
  setDisabled('btn-delete', true, '...');
  await removeLink(editingId);
  setDisabled('btn-delete', false, 'Eliminar');
  showToast(`"${link.name}" eliminado`);
  closeModal();
}

// â”€â”€ Drag libre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTileDrag(tile, link, isNote) {
  let startMX, startMY, startLeft, startTop, moved;

  function pointerDown(e) {
    if (e.target.closest('.tile-btn')) return;
    if (e.button !== undefined && e.button !== 0) return; // solo click izquierdo

    const isTouch = e.type === 'touchstart';
    const pt = isTouch ? e.touches[0] : e;

    startMX   = pt.clientX;
    startMY   = pt.clientY;
    startLeft = parseInt(tile.style.left) || 0;
    startTop  = parseInt(tile.style.top)  || 0;
    moved     = false;

    document.addEventListener(isTouch ? 'touchmove' : 'mousemove', pointerMove, { passive: false });
    document.addEventListener(isTouch ? 'touchend'  : 'mouseup',   pointerUp);
  }

  function pointerMove(e) {
    e.preventDefault();
    const isTouch = e.type === 'touchmove';
    const pt = isTouch ? e.touches[0] : e;

    const dx = pt.clientX - startMX;
    const dy = pt.clientY - startMY;

    if (!moved && (Math.abs(dx) > 4 || Math.abs(dy) > 4)) {
      moved = true;
      isDragging = true;
      tile.classList.add('is-dragging');
    }

    if (moved) {
      tile.style.left = Math.max(0, startLeft + dx) + 'px';
      tile.style.top  = Math.max(0, startTop  + dy) + 'px';
    }
  }

  async function pointerUp(e) {
    const isTouch = e.type === 'touchend';
    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', pointerMove);
    document.removeEventListener(isTouch ? 'touchend'  : 'mouseup',   pointerUp);

    tile.classList.remove('is-dragging');

    if (moved) {
      isDragging = false;
      const x = Math.max(0, parseInt(tile.style.left));
      const y = Math.max(0, parseInt(tile.style.top));
      link.pos_x = x;
      link.pos_y = y;
      await savePosition(link.id, x, y);
    } else {
      isDragging = false;
      // fue un click â€” abrir link o nota
      if (isNote) {
        showNote(link);
      } else if (link.url) {
        window.open(link.url, '_blank', 'noopener,noreferrer');
      }
    }
  }

  tile.addEventListener('mousedown',  pointerDown);
  tile.addEventListener('touchstart', pointerDown, { passive: true });
}

async function savePosition(id, x, y) {
  if (!sb) return;
  await sb.from('links').update({ pos_x: x, pos_y: y }).eq('id', id);
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 2500);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function val(id) { return document.getElementById(id).value.trim(); }
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }

function setDisabled(id, disabled, text) {
  const btn = document.getElementById(id);
  if (!btn) return;
  btn.disabled = disabled;
  if (text) btn.textContent = text;
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderIcon(icon) {
  if (icon && icon.startsWith('http')) {
    return `<img src="${esc(icon)}" alt="" onerror="this.parentElement.textContent='ğŸ”—'">`;
  }
  return esc(icon || 'ğŸ”—');
}

function getFaviconUrl(urlStr) {
  try {
    const { hostname } = new URL(urlStr);
    return `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
  } catch { return null; }
}

function isLight(hex) {
  if (!hex || hex.length < 7) return true;
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return (0.299*r + 0.587*g + 0.114*b) > 155;
}

function getDemoLinks() {
  return [
    { id:'d1', name:'GitHub', url:'https://github.com', icon:'ğŸ™', color:'#34d399', description:'Repositorios', group_name:'Dev', position:0 },
    { id:'d2', name:'Figma', url:'https://figma.com', icon:'ğŸ¨', color:'#a78bfa', description:'DiseÃ±o', group_name:'Dev', position:1 },
    { id:'d3', name:'Notion', url:'https://notion.so', icon:'ğŸ“', color:'#e2e8f0', description:'Notas', group_name:'Dev', position:2 },
    { id:'d4', name:'YouTube', url:'https://youtube.com', icon:'â–¶ï¸', color:'#f87171', description:'', group_name:'', position:3 },
    { id:'d5', name:'Spotify', url:'https://spotify.com', icon:'ğŸµ', color:'#4ade80', description:'', group_name:'', position:4 },
  ];
}

// â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Auth
document.getElementById('tab-login-btn').addEventListener('click', () => switchTab('login'));
document.getElementById('tab-signup-btn').addEventListener('click', () => switchTab('signup'));
document.getElementById('btn-login').addEventListener('click', login);
document.getElementById('btn-signup').addEventListener('click', signup);
document.getElementById('btn-logout').addEventListener('click', logout);

document.getElementById('login-pass').addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
document.getElementById('login-email').addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
document.getElementById('signup-pass').addEventListener('keydown', e => { if (e.key === 'Enter') signup(); });

// Dashboard
document.getElementById('btn-add').addEventListener('click', () => openModal(null));
document.getElementById('btn-cancel').addEventListener('click', closeModal);
document.getElementById('btn-save').addEventListener('click', saveLink);
document.getElementById('btn-delete').addEventListener('click', deleteLink);

document.getElementById('overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('overlay')) closeModal();
});
document.querySelector('.modal').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) saveLink();
  if (e.key === 'Escape') closeModal();
});

// Note popup events
document.getElementById('note-popup-close').addEventListener('click', closeNote);
document.getElementById('note-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('note-overlay')) closeNote();
});
document.getElementById('note-popup-edit').addEventListener('click', e => {
  closeNote();
  openModal(e.currentTarget.dataset.id);
});

// URL field: update description label + favicon preview
document.getElementById('f-url').addEventListener('input', e => {
  const hasUrl = e.target.value.trim().length > 0;
  document.getElementById('desc-label').textContent = hasUrl ? 'DescripciÃ³n (opcional)' : 'Contenido de la nota';
  document.getElementById('f-desc').rows = hasUrl ? 2 : 5;

  const faviconUrl = getFaviconUrl(e.target.value);
  const row = document.getElementById('favicon-row');
  const preview = document.getElementById('favicon-preview');

  if (faviconUrl) {
    preview.innerHTML = `<img src="${faviconUrl}" alt="">`;
    row.classList.remove('hidden');
  } else {
    row.classList.add('hidden');
    preview.innerHTML = '';
  }
});

document.getElementById('favicon-use-btn').addEventListener('click', () => {
  const faviconUrl = getFaviconUrl(document.getElementById('f-url').value);
  if (faviconUrl) {
    document.getElementById('f-icon').value = faviconUrl;
    showToast('Favicon aplicado como Ã­cono');
  }
});

document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value.trim().toLowerCase();
  render();
});

document.getElementById('site-title').addEventListener('input', e => {
  localStorage.setItem(TITLE_KEY, e.target.value);
  document.title = e.target.value.replace(/[^\w\s]/g,'').trim() || 'Mi Tablero';
});

// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
